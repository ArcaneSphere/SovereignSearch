<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SovereignSearch</title>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<style>
  /* ---------- Scoped Search Page ---------- */
  body {
  overflow-y: scroll; /* reserve scrollbar space */
  }

  #searchPage {
    font-family: Arial, Helvetica, sans-serif;
    background: #fafafa;
    color: #202124;
    min-height: 100%;
    overflow-y: auto;
    padding-bottom: 40px;
  }

  #searchPage h2 {
    text-align: center;
    margin-top: 30px;
    font-weight: normal;
  }

  #searchPage #searchBox {
    display: block;
    margin: 30px auto;
    width: 60%;
    max-width: 600px;
    padding: 12px 16px;
    font-size: 16px;
    border: 1px solid #dcdcdc;
    border-radius: 24px;
    outline: none;
  }

  #searchPage #searchBox:focus {
    border-color: #4285f4;
  }

  #searchPage #status {
    text-align: center;
    margin-bottom: 24px;
    color: #5f6368;
    font-size: 14px;
  }

  #searchPage #results {
    width: 80%;
    max-width: 900px;
    margin: 0 auto;
  }

  /* ---------- Result Row ---------- */
  #searchPage .result {
    padding: 8px 0 20px 0;
    border-bottom: 1px solid #eee;
  }

  /* Title */
  #searchPage .nameHdr {
    font-size: 20px;
    line-height: 1.3;
    margin-bottom: 4px;
    color: #1a0dab;
  }

  /* SCID */
  #searchPage .scid {
    font-size: 13px;
    color: #0066cc;
    cursor: pointer;
    word-break: break-all;
    margin-bottom: 4px;
  }

  #searchPage .scid:hover {
    text-decoration: underline;
  }

  /* URL */
  #searchPage .url {
    font-size: 14px;
    color: #202124;
    margin-bottom: 6px;
    word-break: break-all;
  }

  /* Description */
  #searchPage .descr {
    font-size: 14px;
    line-height: 1.5;
    color: #4d5156;
    max-width: 90%;
  }
</style>
</head>

<body>

<div id="searchPage">

  <h2>Search</h2>

  <input
    id="searchBox"
    type="text"
    placeholder="Search SCID, dURL, name or description..."
    disabled
  />

  <div id="status">Fetching indexed SCIDs...</div>
  <div id="results"></div>

</div>

<script>
const apiBase = "http://127.0.0.1:8099/api";

let allResults = [];
let fuse;

// Fetch all indexed SCIDs
async function fetchAllSCIDs() {
  const resp = await fetch(`${apiBase}/indexedscs`);
  if (!resp.ok) throw new Error("Failed to fetch indexed SCIDs");
  const data = await resp.json();
  return Object.keys(data.indexedscs || {});
}

// Fetch SCID variables
async function fetchSCIDData(scid) {
  try {
    const resp = await fetch(`${apiBase}/scvarsbyheight?scid=${scid}`);
    if (!resp.ok) return null;

    const data = await resp.json();
    if (!data.variables) return null;

    let dURL = "";
    let nameHdr = "";
    let descrHdr = "";

    data.variables.forEach(v => {
      if (v.Key === "dURL") dURL = v.Value;
      if (v.Key === "nameHdr") nameHdr = v.Value;
      if (v.Key === "descrHdr") descrHdr = v.Value;
    });

    if (!dURL) return null;

    return { scid, dURL, nameHdr, descrHdr };
  } catch {
    return null;
  }
}

// Render results
function renderResults(results) {
  const container = document.getElementById("results");
  container.innerHTML = "";

  results.forEach(r => {
    const div = document.createElement("div");
    div.className = "result";

    div.innerHTML = `
      <div class="nameHdr">${r.nameHdr}</div>

      <div class="scid" onclick="handleSCIDClick('${r.scid}')">
        ${r.scid}
      </div>

      <div class="url">${r.dURL}</div>

      <div class="descr">${r.descrHdr}</div>
    `;

    container.appendChild(div);
  });
}

// CLICK HANDLER â€” this is the only integration point
function handleSCIDClick(scid) {
  if (!window.electronAPI?.selectSCID) {
    console.warn("selectSCID not available");
    return;
  }

  window.electronAPI.selectSCID(scid);
}

// Fuzzy filtering
function filterResults(query) {
  if (!query.trim()) {
    renderResults(allResults);
    return;
  }

  const results = fuse.search(query);
  renderResults(results.map(r => r.item));
}

// Load everything once
async function loadSCIDs() {
  const status = document.getElementById("status");
  const searchBox = document.getElementById("searchBox");

  const scids = await fetchAllSCIDs();
  status.textContent = `Scanning ${scids.length} SCIDs...`;

  for (const scid of scids) {
    const res = await fetchSCIDData(scid);
    if (res) allResults.push(res);
  }

  status.textContent = `Loaded ${allResults.length} SCIDs with dURL`;
  searchBox.disabled = false;

  fuse = new Fuse(allResults, {
    keys: [
      { name: "scid", weight: 2 },
      { name: "dURL", weight: 1.5 },
      { name: "nameHdr", weight: 1 },
      { name: "descrHdr", weight: 0.8 }
    ],
    threshold: 0.25,
    ignoreLocation: true,
    minMatchCharLength: 2
  });

  renderResults(allResults);
}

document.getElementById("searchBox").addEventListener("input", e => {
  filterResults(e.target.value);
});

loadSCIDs();
</script>

</body>
</html>
